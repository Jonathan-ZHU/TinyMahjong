{"version":3,"sources":["assets/scripts/components/LoadingLogic.js"],"names":["cc","Class","extends","Component","properties","tipLabel","Label","_stateStr","_progress","_splash","_isLoading","onLoad","sys","isNative","isMobile","cvs","node","getComponent","Canvas","fitHeight","fitWidth","initMgr","string","find","active","vv","http","sendRequest","data","localStorage","setItem","youkeorweixin","getItem","os","OS_IOS","start","self","SHOW_TIME","FADE_TIME","t","Date","now","fn","dt","setTimeout","op","opacity","checkVersion","UserMgr","require","userMgr","ReplayMgr","replayMgr","global","net","GameNetMgr","gameNetMgr","initHandlers","AnysdkMgr","anysdkMgr","init","VoiceMgr","voiceMgr","AudioMgr","audioMgr","Utils","utils","args","urlParse","params","window","location","name","value","str","href","num","indexOf","substr","arr","split","i","length","substring","onGetVersion","ret","version","console","log","SI","VERSION","startPreloading","xhr","complete","fnRequest","abort","onBtnDownloadClicked","openURL","appweb","loader","onProgress","completedCount","totalCount","item","loadResAll","err","assets","onLoadComplete","director","loadScene","onComplete","update","Math","floor"],"mappings":"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","file":"unknown","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        tipLabel:cc.Label,\n        _stateStr:'',\n        _progress:0.0,\n        _splash:null,\n        _isLoading:false,\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        if(!cc.sys.isNative && cc.sys.isMobile){\n            var cvs = this.node.getComponent(cc.Canvas);\n            cvs.fitHeight = true;\n            cvs.fitWidth = true;\n        }\n        this.initMgr();\n        this.tipLabel.string = this._stateStr;\n        \n        this._splash = cc.find(\"Canvas/splash\");\n        this._splash.active = true;\n        \n        cc.vv.http.sendRequest(\"/mj_login\", 1, function(data){\n            cc.sys.localStorage.setItem(\"youkeorweixin\", data.data.youkeorweixin);\n            if (cc.sys.localStorage.getItem(\"youkeorweixin\")==\"0\" && cc.sys.os == cc.sys.OS_IOS) {\n                cc.find(\"Canvas/New Label\").active = false;  \n            }\n        });\n        \n        \n    },\n    \n    start:function(){        \n        var self = this;\n        var SHOW_TIME = 3000;\n        var FADE_TIME = 500;\n        if(cc.sys.os != cc.sys.OS_IOS || !cc.sys.isNative){\n            self._splash.active = true;\n            var t = Date.now();\n            var fn = function(){\n                var dt = Date.now() - t;\n                if(dt < SHOW_TIME){\n                    setTimeout(fn,33);\n                }\n                else {\n                    var op = (1 - ((dt - SHOW_TIME) / FADE_TIME)) * 255;\n                    if(op < 0){\n                        self._splash.opacity = 0;\n                        self.checkVersion();    \n                    }\n                    else{\n                        self._splash.opacity = op;\n                        setTimeout(fn,33);   \n                    }\n                }\n            };\n            setTimeout(fn,33);\n        }\n        else{\n            this._splash.active = false;\n            this.checkVersion();\n        }\n    },\n    \n    initMgr:function(){\n        cc.vv = {};\n        var UserMgr = require(\"UserMgr\");\n        cc.vv.userMgr = new UserMgr();\n        \n        var ReplayMgr = require(\"ReplayMgr\");\n        cc.vv.replayMgr = new ReplayMgr();\n        \n        cc.vv.http = require(\"HTTP\");\n        cc.vv.global = require(\"Global\");\n        cc.vv.net = require(\"Net\");\n        \n        var GameNetMgr = require(\"GameNetMgr\");\n        cc.vv.gameNetMgr = new GameNetMgr();\n        cc.vv.gameNetMgr.initHandlers();\n        \n        var AnysdkMgr = require(\"AnysdkMgr\");\n        cc.vv.anysdkMgr = new AnysdkMgr();\n        cc.vv.anysdkMgr.init();\n        \n        var VoiceMgr = require(\"VoiceMgr\");\n        cc.vv.voiceMgr = new VoiceMgr();\n        cc.vv.voiceMgr.init();\n        \n        var AudioMgr = require(\"AudioMgr\");\n        cc.vv.audioMgr = new AudioMgr();\n        cc.vv.audioMgr.init();\n        \n        var Utils = require(\"Utils\");\n        cc.vv.utils = new Utils();\n        \n        cc.args = this.urlParse();\n    },\n    \n    urlParse:function(){\n        var params = {};\n        if(window.location == null){\n            return params;\n        }\n        var name,value; \n        var str=window.location.href; //取得整个地址栏\n        var num=str.indexOf(\"?\") \n        str=str.substr(num+1); //取得所有参数   stringvar.substr(start [, length ]\n        \n        var arr=str.split(\"&\"); //各个参数放到数组里\n        for(var i=0;i < arr.length;i++){ \n            num=arr[i].indexOf(\"=\"); \n            if(num>0){ \n                name=arr[i].substring(0,num);\n                value=arr[i].substr(num+1);\n                params[name]=value;\n            } \n        }\n        return params;\n    },\n    \n    checkVersion:function(){\n        var self = this;\n        var onGetVersion = function(ret){\n            if(ret.version == null){\n                console.log(\"error.\");\n            }\n            else{\n                cc.vv.SI = ret;\n                if(ret.version != cc.VERSION){\n                    cc.find(\"Canvas/alert\").active = true;\n                }\n                else{\n                    self.startPreloading();\n                }\n            }\n        };\n        \n        var xhr = null;\n        var complete = false;\n        var fnRequest = function(){\n            self._stateStr = \"正在连接服务器\";\n            xhr = cc.vv.http.sendRequest(\"/get_serverinfo\",null,function(ret){\n                xhr = null;\n                complete = true;\n                onGetVersion(ret);\n            });\n            setTimeout(fn,5000);            \n        }\n        \n        var fn = function(){\n            if(!complete){\n                if(xhr){\n                    xhr.abort();\n                    self._stateStr = \"连接失败，即将重试\";\n                    setTimeout(function(){\n                        fnRequest();\n                    },5000);\n                }\n                else{\n                    fnRequest();\n                }\n            }\n        };\n        fn();\n    },\n    \n    onBtnDownloadClicked:function(){\n        cc.sys.openURL(cc.vv.SI.appweb);\n    },\n    \n    startPreloading:function(){\n        this._stateStr = \"正在加载资源，请稍候\";\n        this._isLoading = true;\n        var self = this;\n        \n        cc.loader.onProgress = function ( completedCount, totalCount,  item ){\n            //console.log(\"completedCount:\" + completedCount + \",totalCount:\" + totalCount );\n            if(self._isLoading){\n                self._progress = completedCount/totalCount;\n            }\n        };\n        \n        cc.loader.loadResAll(\"textures\", function (err, assets) {\n            self.onLoadComplete();\n        });      \n    },\n    \n    onLoadComplete:function(){\n        this._isLoading = false;\n        this._stateStr = \"准备登陆\";\n        cc.director.loadScene(\"login\");\n        cc.loader.onComplete = null;\n    },\n\n    // called every frame, uncomment this function to activate update callback\n    update: function (dt) {\n        if(this._stateStr.length == 0){\n            return;\n        }\n        this.tipLabel.string = this._stateStr + ' ';\n        if(this._isLoading){\n            this.tipLabel.string += Math.floor(this._progress * 100) + \"%\";   \n        }\n        else{\n            var t = Math.floor(Date.now() / 1000) % 4;\n            for(var i = 0; i < t; ++ i){\n                this.tipLabel.string += '.';\n            }            \n        }\n    }\n});"]}